---
nav_title: "プッシュ登録"
article_title: プッシュ登録
page_order: 2
page_type: reference
description: "この参考記事では、プッシュ登録の意味と、Brazeにおけるプッシュメッセージの送信方法、プッシュトークンとプッシュ登録の扱いについて説明する。"
channel:
  - push

---

# プッシュ登録

> この記事では、ユーザーがプッシュトークンを割り当てられるまでのプロセスと、Brazeがユーザーにプッシュメッセージを送信する方法について説明する。

## プッシュトークン

プッシュトークンとそれが何であるかを理解することは、Brazeでプッシュメッセージを送信する方法を理解するための基本的な要素である。プッシュトークンは、ユーザーのデバイスによって生成され、各受信者の通知を送信する場所を特定するためにBrazeに送信される一意の匿名識別子である。デバイスがプッシュトークンを持っていない場合、プッシュを送信する方法はない。

プッシュトークンはプッシュサービスプロバイダによって生成される。Brazeは、AndroidのFirebase Cloud Messaging Service（FCM）やiOSのApple Push Notification Service（APN）のようなプッシュサービスプロバイダーと接続し、これらのプロバイダーは、あなたのアプリを識別するユニークなデバイストークンを送信する。各デバイスは、メッセージングに使用されるユニークなトークンを1つずつ持っている。トークンは[期限切れや](#push-token-expire)更新が可能である。

プッシュトークン]\[プッシュトークン] ]には2つの分類方法があり、プッシュ通知をユーザーに送る方法を理解するのに欠かせない。

1. **フォアグラウンド・プッシュは**、ユーザーのデバイスのフォアグラウンドに定期的に目に見えるプッシュ通知を送信する機能を提供する。
2. **バックグラウンド・プッシュは**、特定のデバイスがそのブランドからのプッシュ通知を受け取ることをオプトインしているかどうかに関係なく利用できる。バックグラウンド・プッシュでは、ブランドはサイレント・プッシュ通知（意図的に表示されない通知）をデバイスに送信し、アンインストール追跡のような重要な機能をサポートすることができる。

ユーザープロファイルにアプリに関連付けられた有効なフォアグラウンドプッシュトークンがある場合、Brazeはそのユーザーを指定されたアプリの「プッシュ登録済み」とみなす。そこでBrazeは、このようなユーザーを特定するための特定のセグメンテーションフィルター、`Push enabled for App,` 。

{% alert note %}
`Push enabled for App` フィルタは、指定されたアプリの有効なフォアグラウンドまたはバックグラウンドプッシュトークンの存在のみを考慮する。しかし、より一般的な`Push Enabled` フィルタは、ワークスペース内のアプリのプッシュ通知を明示的に有効にしているユーザーをセグメントする。このカウントには、フォアグラウンド・プッシュのみが含まれ、購読を解除したユーザーは含まれない。これらのフィルターやその他のフィルターについては、[セグメンテーション・フィルターで]({{site.baseurl}}/user_guide/engagement_tools/segments/segmentation_filters)詳しく説明されている。
{% endalert %}

### 1台のデバイスで複数のユーザーが利用できる

プッシュトークンはデバイスとアプリの両方に固有なので、プッシュトークンを使って同じデバイスを使っている複数のユーザーを区別することはできない。

例えば、2人のユーザーがいるとする：チャーリーとキムだ。チャーリーが自分の携帯電話であなたのアプリのプッシュ通知を有効にしている場合、キムがチャーリーの携帯電話を使ってチャーリーのプロフィールからログアウトし、自分のプロフィールにログインすると、プッシュトークンはキムのプロフィールに再割り当てされる。プッシュトークンは、キムがログアウトし、チャーリーが再度ログインするまで、そのデバイスのキムのプロファイルに割り当てられたままとなる。

アプリやウェブサイトは、1つのデバイスにつき1つのプッシュ購読しかできない。そのため、ユーザーがデバイスやウェブサイトからログアウトし、新しいユーザーがログインすると、プッシュトークンは新しいユーザーに再割り当てされる。これは、**Engagement**タブの**Contact Settings**セクションにあるユーザーのプロフィールに反映される：

![ユーザーのプロフィールの\*\*Engagement**タブにあるプッシュトークンの変更履歴。][4]

プッシュ・プロバイダ（APN/FCM）には、1つのデバイス上の複数のユーザーを区別する方法がないため、最後にログインしたユーザーにプッシュ・トークンを渡し、デバイス上のどのユーザーをプッシュのターゲットにするかを決定する。

## プッシュトークン登録

各プラットフォームは、プッシュトークンの登録とプッシュ許可の処理をさまざまな方法で行っている：

- **Android**:
  - **Android 13**:<br>プッシュの許可はユーザーに求め、許可を得なければならない。ユーザーからパーミッションが与えられた後にトークンを受け取る。あなたのアプリは、適切なタイミングでユーザーに手動で許可を求めることができるが、そうでない場合は、アプリが[通知チャネルを](https://developer.android.com/reference/android/app/NotificationChannel)作成した後、ユーザーに自動的にプロンプトが表示される。
  - **アンドロイド12以前**：<br>すべてのユーザーは、Brazeが自動的にプッシュトークンを要求する最初のセッション時に、`Subscribed` 。この時点で、ユーザーはそのデバイスの有効なプッシュトークンと、`Subscribed` というデフォルトのサブスクリプション状態で**プッシュ有効になって**いる。<br><br>
- **iOS**:自動的にプッシュ登録されるわけではない。
    - **iOS 12（暫定認証あり）**：<br>アプリは、[仮承認]({{site.baseurl}}/user_guide/message_building_by_channel/push/ios/notification_options/#provisional-push)または承認されたプッシュを要求することができる。一方、\[provisional push]\[provisional-blog] ] は、音やアラートなしで、通知センターに直接、__静かに__通知を送ることができる。
    - **iOS 11以降およびiOS 12（暫定認証なし）**：<br>すべてのユーザーは、プッシュ通知の受信を明示的にオプトインしなければならない。ユーザーがオプトインした後、トークンを受け取る。<br><br>
- **Web:**ネイティブブラウザの許可ダイアログを通じて、ユーザーに明示的なオプトインを要求しなければならない。ユーザーがオプトインした後、トークンを受け取る。 iOSやAndroidでは、アプリはいつでも許可プロンプトを表示できるが、最近のブラウザの中には、「ユーザージェスチャー」（マウスクリックやキーストローク）によってのみプロンプトを表示するものもある。もしあなたのサイトがページロード時にプッシュ通知の許可を要求しようとすれば、おそらくブラウザによって無視されるか、沈黙させられるだろう。

| プッシュトークンを取得する | プッシュトークンを送信する |
| ---------------- | ----------------- |
| アプリケーションは、デバイスのプッシュトークンを取得するために、プッシュ・プロバイダに登録しなければならない。 | 開発者は、FCM/APNによって生成されたプッシュトークンを使ってデバイスをターゲットにすることができる。|
{: .reset-td-br-1 .reset-td-br-2}

### ユーザーのプッシュ購読状態をチェックする

![John Doeのユーザープロファイルで、プッシュ購読の状態がSubscribedに設定されている。][3]{: style="float:right;max-width:35%;margin-left:15px;"}

Brazeでユーザーのプッシュ購読状態を確認するには、2つの方法がある：

1. **ユーザープロフィール][5]Brazeダッシュボードの\[User Search][5] ]ページから、個々のユーザープロファイルにアクセスできる。Eメールアドレス、電話番号、または外部ユーザーIDを介して）ユーザーのプロフィールを見つけた後、**Engagement**タブを選択してユーザーの購読状態を表示し、手動で調整することができる。 
<br>
2.**Rest API Export***：エクスポート [Users by segment][segment] ]] または [Users by identifier][identifier] ] エンドポイントを使用して、個々のユーザー・プロファイルを JSON 形式でエクスポートできる。Brazeは、デバイスごとのプッシュ有効化情報を含むプッシュトークンオブジェクトを返す。

### プッシュ登録状況を確認する

ユーザーのプロフィールの**Engagement**タブには、**Push Registered Forの**後にアプリ名が表示される。そのデバイスのアプリ情報が存在しない場合は、2つのダッシュ**（--）が**表示される。ユーザーに属するすべてのデバイスのエントリーが存在することになる。

デバイスエントリーのアプリ名の前に`Foreground:` が付いている場合、そのアプリはそのデバイス上でフォアグラウンド・プッシュ通知（ユーザーに見える）とバックグラウンド・プッシュ通知（ユーザーに見えない）の両方を受信する権限を持つ。

![プッシュトークンの例でChangelogをプッシュする。][2]{: style="float:right;max-width:40%;margin-left:15px;margin-top:10px;"}

一方、デバイスエントリーのアプリ名の先頭に`Background:` が付いている場合、そのアプリは[バックグラウンドプッシュの]({{site.baseurl}}/user_guide/message_building_by_channel/push/types/#background-push-notifications)受信のみが許可されており、そのデバイス上でユーザーから見える通知を表示することはできない。これは通常、ユーザーがそのデバイスでアプリの通知を無効にしていることを示す。

プッシュトークンを同じデバイスの別のユーザーに移動すると、最初のユーザーはプッシュ登録されなくなる。

## プッシュトークンの管理

プッシュトークンの変更またはユーザープロファイルからの削除につながるアクションについては、以下のチャートをチェックしてほしい。 

| アクション (Action) | 説明 |
| ------ | ----------- |
| `changeUser()` というメソッドがある。 | Braze`changeUser()` メソッドは、SDKがユーザー行動データを割り当てるユーザーIDを切り替える。このメソッドは通常、ユーザーがアプリケーションにログインするときに呼び出される。`changeUser()` 、特定のデバイスで異なるユーザーIDまたは新しいユーザーIDで呼び出されると、そのデバイスのプッシュトークンは、対応するユーザーIDを持つ適切なBrazeプロファイルに移動する。 |
| プッシュエラー発生 | トークン削除につながる一般的なプッシュエラーには、`MismatchSenderId` 、`InvalidRegistration` 、その他のプッシュバウンスがある。<br><br>よくある[プッシュエラーの][errors]リストをご覧いただきたい。 |
| ユーザーがアンインストールする | ユーザーがデバイスからアプリケーションをアンインストールすると、Brazeはユーザーのプッシュトークンをプロファイルから削除する。 |
{: .reset-td-br-1 .reset-td-br-2}

### これはより広いスケールで見るとどうなるのだろうか？

ユーザーが新しいアプリケーションを開き、プッシュプロンプトからプッシュアクセスを許可すると、Braze SDKからプッシュプロバイダーへの呼び出しが行われる。この呼び出しが行われると、プッシュ・プロバイダはすべてが正しく設定されているかどうかのチェックを行う。もしそうなら、プッシュトークンがあなたのデバイスに渡される。トークンが到着すると、SDKはこれをBrazeに伝える。Brazeがプッシュプロバイダからトークンを受け取った後、ユーザープロファイルを更新または新規作成する。これらのユーザーは登録済みとみなされる。

キャンペーンを開始したい場合は、Brazeでキャンペーンを作成し、プッシュ・ペイロードを生成してプッシュ・プロバイダに送信する。そこから、プロバイダーはユーザーのデバイスにプッシュペイロードを配信し、SDKはメッセージング状態をBrazeに渡す。

![前述のBraze、顧客、Apple Push Notification ServiceまたはFirebase Cloud Messaging間のプッシュプロセスをマッピングしたフローチャート。]\[push-process]

| 登録ステップ | メッセージング・ステップ |
| ------------------ | --------------- |
| 1\.顧客（デバイス）がプッシュ・プロバイダに登録する<br>2\.プロバイダーがプッシュトークンを生成し、配信する<br>3\.Brazeのフラッシュ・トークン |1\.Brazeはプッシュペイロードをプロバイダーに送る<br>2\.プロバイダーはプッシュペイロードをデバイスに配信する。<br>3\.SDKはメッセージング統計情報をBrazeに渡す |
{: .reset-td-br-1 .reset-td-br-2}

## よくある質問

### オプトインしたユーザーがアプリを削除し、再ダウンロードした場合はどうなるのか？

あるユーザーがプッシュを選択し、プッシュメッセージを受け取った後、アプリを削除したとする。これにより、デバイス・レベルでのプッシュ同意が削除される。ここから、アンインストール後の最初のバウンスプッシュは、自動的にそのユーザーを今後のプッシュメッセージングからオプトアウトすることになる。この後、ユーザーがアプリを再インストールしても起動しなかった場合、Brazeはプッシュトークンをユーザーに送信できない。

さらに、ユーザーがフォアグラウンド・プッシュを再び有効にする場合、プッシュ・メッセージングの受信を開始するために、ユーザー・プロファイルのこの情報を更新するためにセッションを開始する必要がある。
 
### プッシュトークンの有効期限は？ {#push-token-expire}

残念ながら、APNとFCMはこれを定義していない。プッシュトークンは、アプリがアップデートされた時、ユーザーが新しいデバイスにデータを移した時、OSを再インストールした時などに失効することがある。ほとんどの場合、なぜプッシュ・プロバイダが特定のプッシュ・トークンを失効させるのか、私たちにはよくわからない。

この曖昧さを考慮し、SDKプッシュ統合は常にセッション開始時にトークンを登録し、フラッシュすることで、最新のトークンを確保している。

[errors]: {{site.baseurl}}/help/help_articles/push/push_error_codes/#push-bounced-mismatchsenderid
[identifier]: {{site.baseurl}}/api/endpoints/export/user_data/post_users_identifier/
[segment]: {{site.baseurl}}/api/endpoints/export/user_data/post_users_segment/
\[push-process] ： {% image_buster /assets/img/push_process.png %}
[5]: {{site.baseurl}}/user_guide/engagement_tools/segments/using_user_search/
[2]: {% image_buster /assets/img/push_changelog.png %}
\[push-tokens]: {{site.baseurl}}/user_guide/message_building_by_channel/push/push_registration/
[3]: {% image_buster /assets/img/push_example.png %}
[4]: {% image_buster /assets/img/push_token_changelog.png %}


